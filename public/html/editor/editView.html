<div x-data="editView" class="border border-vls/40 h-full ml-2 rounded p-2">
  <!-- When no invoice is selected or none is being edited -->
  <template x-if="!$store.edit.showInvoiceItems">
    <div
      x-ref="tempText"
      class="flex h-full w-full items-center justify-center text-center align-middle text-vls3 dark:text-vds">
      <p class="text-xl">Pick an invoice from the list to edit.</p>
    </div>
  </template>

  <!-- When an invoice is selected but not in edit mode -->
  <template x-if="$store.edit.showInvoiceItems && !$store.edit.editing">
    <div class="alt-table-scrollbar max-h-[100%] w-full overflow-y-auto text-vls2 dark:text-vds">
      <!-- Header / Basic Info -->
      <div
        class="mb-2 flex w-full justify-between rounded bg-vlp border border-vls/40 shadow p-2 text-center text-vls2 dark:text-vds font-medium dark:bg-vdp">
        <div>
          <span class="mr-1">Invoice:</span>
          <span x-text="$store.edit.invoiceItems.invoice?.invoice_number"></span>
        </div>
        <div>
          <span class="ml-4 mr-1">Date:</span>
          <span x-text="$store.edit.invoiceItems.invoice?.date"></span>
        </div>
      </div>
      <!-- Client Details -->
      <div class="mb-2 flex w-full justify-between rounded border bg-vlp shadow dark:bg-vdp2 border-vls/40 p-2">
        <div class="w-full">
          <div class="flex justify-between w-full">
            <p>Client name:</p>
            <span x-text="$store.edit.invoiceItems.client?.name"></span>
          </div>
          <div class="flex justify-between w-full">
            <p>Company:</p>
            <span x-text="$store.edit.invoiceItems.client?.company_name"></span>
          </div>
          <div class="flex justify-between w-full">
            <p>Address:</p>
            <span x-text="$store.edit.invoiceItems.client?.address"></span>
          </div>
          <div class="flex justify-between w-full">
            <p>Email:</p>
            <span x-text="$store.edit.invoiceItems.client?.email"></span>
          </div>
        </div>
      </div>
      <!-- Invoice Items Table -->
      <div class="alt-table-scrollbar mb-2 w-full overflow-y-auto border rounded border-vls/40 p-1">
        <table class="w-[calc(100%-10px)] table-auto border-separate px-0.5" style="border-spacing: 0 10px">
          <thead class="sticky top-0 table-head-style border-clipper">
            <tr>
              <th class="p-2 text-start px-2 round-left-border">Name</th>
              <th class="p-2">Type</th>
              <th class="p-2 text-right">Qty</th>
              <th class="p-2 round-right-border text-right">Price</th>
            </tr>
          </thead>
          <tbody class="table-body-style table-scrollbar">
            <template x-for="item in $store.edit.invoiceItems.invoiceItems" :key="item.id">
              <tr class="border-hover-ring-efect">
                <td class="round-left-border w-[75%] px-2 py-1 text-sm" x-text="item.name"></td>
                <td class="px-2 py-1" x-text="item.type"></td>
                <td class="w-[15%] px-2 py-1 text-sm text-right" x-text="item.quantity"></td>
                <td class="round-right-border w-[10%] px-4 py-1 text-right text-sm" x-text="'£' + item.price"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <!-- Prices -->
      <div
        class="mb-2 flex flex-col w-full justify-between rounded border bg-vlp shadow dark:bg-vdp2 border-vls/40 p-2">
        <p x-text="'Subtotal: £' + $store.edit.invoiceItems.invoice?.subtotal"></p>
        <p x-text="'VAT: £' + $store.edit.invoiceItems.invoice?.vat"></p>

        <!-- Show Discount only if discount_type != 0 -->
        <template
          x-if="$store.edit.invoiceItems.invoice?.discount_type && $store.edit.invoiceItems.invoice?.discount_type !== 0">
          <!-- If discount_type === 1 -> Flat -->
          <template x-if="$store.edit.invoiceItems.invoice?.discount_type === 1">
            <p x-text="'Discount: £' + $store.edit.invoiceItems.invoice?.discount_value"></p>
          </template>

          <!-- If discount_type === 2 -> Percent -->
          <template x-if="$store.edit.invoiceItems.invoice?.discount_type === 2">
            <p x-text="'Discount: ' + $store.edit.invoiceItems.invoice?.discVal_ifPercent + '%'"></p>
          </template>
        </template>

        <!-- Show Deposit only if deposit_type != 0 -->
        <template
          x-if="$store.edit.invoiceItems.invoice?.deposit_type && $store.edit.invoiceItems.invoice?.deposit_type !== 0">
          <!-- If deposit_type === 1 -> Flat -->
          <template x-if="$store.edit.invoiceItems.invoice?.deposit_type === 1">
            <p x-text="'Deposit: £' + $store.edit.invoiceItems.invoice?.deposit_value"></p>
          </template>

          <!-- If deposit_type === 2 -> Percent -->
          <template x-if="$store.edit.invoiceItems.invoice?.deposit_type === 2">
            <p x-text="'Deposit: ' + $store.edit.invoiceItems.invoice?.depoVal_ifPercent + '%'"></p>
          </template>
        </template>

        <p x-text="'Total: £' + $store.edit.invoiceItems.invoice?.total"></p>
        <p x-text="'Note: ' + $store.edit.invoiceItems.invoice?.note"></p>
      </div>

      <div class="flex gap-4 justify-end">
        <button
          x-show="$store.edit.edited"
          @click="$store.pdfStore.generateInvoice()"
          class="modal-btn-sec flex items-center">
          <svg class="size-4 mr-1">
            <use href="/icons/icons.svg#download-document" />
          </svg>
          PDF
        </button>
        <button @click="$store.edit.openEditModal = true" class="modal-btn-prim flex">
          <svg class="size-4">
            <use href="/icons/icons.svg#editor" />
          </svg>
          Edit Invoice
        </button>
      </div>
    </div>
  </template>

  <!-- Edit Mode (overwrite or copy) -->
  <template x-if="$store.edit.editing">
    <div class="alt-table-scrollbar max-h-[100%] w-full overflow-y-auto text-vls2 dark:text-vds">
      <!-- Header / Basic Info in Edit Mode -->
      <div
        class="mb-2 flex w-full justify-between rounded bg-vlp border border-vls/40 shadow p-2 text-center text-vls2 dark:text-vds font-medium dark:bg-vdp">
        <div>
          <span class="mr-1">Invoice:</span>
          <span x-text="$store.edit.invoiceItems.invoice?.invoice_number"></span>
          <span class="ml-4 mr-1">Date:</span>
          <span x-text="$store.edit.invoiceItems.invoice?.date"></span>
          <span class="ml-4">
            Edit Mode:
            <span x-show="$store.edit.editMode === 'editOverwrite'">Overwrite</span>
            <span x-show="$store.edit.editMode === 'editCopy'">Copy</span>
          </span>
        </div>
        <div class="flex items-center gap-2">
          <!-- Cancel edit -->
          <button @click="$store.edit.cancelEdit()" class="modal-btn-sec flex items-center">Cancel</button>
          <!-- Save edit -->
          <button @click="$store.edit.saveEdit()" class="modal-btn-prim flex items-center">Save</button>
        </div>
      </div>

      <!-- Editable Invoice Items -->
      <div class="mb-2 flex w-full justify-between rounded border border-vls/40 bg-vlp shadow dark:bg-vdp2 p-2">
        <!-- Client info -->
        <div>
          <p>
            Client name:
            <span x-text="$store.edit.invoiceItems.client?.name"></span>
          </p>
          <p>
            Company:
            <span x-text="$store.edit.invoiceItems.client?.company_name"></span>
          </p>
          <p>
            Address:
            <span x-text="$store.edit.invoiceItems.client?.address"></span>
          </p>
          <p>
            Email:
            <span x-text="$store.edit.invoiceItems.client?.email"></span>
          </p>
        </div>
        <!-- Add Item Button -->
        <div class="flex flex-col justify-center">
          <button
            @click="
              $store.edit.existingItems.showItemModal = true;
              $store.edit.fetchStylesAndSamples($store.clients.selectedClient?.id);
            "
            class="butt-style !bg-vlp dark:!bg-zinc-900">
            Add Item
          </button>
        </div>
      </div>
      <!-- Items Table -->
      <div
        class="alt-table-scrollbar mb-2 w-full overflow-y-auto border rounded border-vls/40 bg-vlp shadow p-1 dark:bg-vdp2">
        <table class="w-full table-auto border-separate px-0.5" style="border-spacing: 0 10px">
          <thead class="sticky top-0 table-head-style border-clipper">
            <tr>
              <th class="p-2 round-left-border">Name</th>
              <th class="p-2">Type</th>
              <th class="p-2">Qty</th>
              <th class="p-2">Price</th>
              <th class="p-2 round-right-border">Actions</th>
            </tr>
          </thead>
          <tbody class="table-body-style table-scrollbar">
            <template x-for="(item, idx) in $store.edit.invoiceItems.invoiceItems" :key="item.id">
              <tr class="border-hover-ring-efect">
                <td class="p-1" x-text="item.name"></td>
                <td class="p-1" x-text="item.type"></td>
                <td class="p-1 text-right" x-text="item.quantity"></td>
                <td class="p-1 text-right" x-text="'£' + item.price"></td>
                <td class="p-1 text-center">
                  <button @click="$store.edit.removeInvoiceItem(item.id)" class="table-interaction-icon-red">
                    <svg class="size-4">
                      <use href="/icons/icons.svg#trash" />
                    </svg>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <!-- Editable Prices -->
      <div
        class="mb-2 flex flex-col w-full justify-between rounded border border-vls/40 bg-vlp shadow dark:bg-vdp2 p-2">
        <p x-text="'Subtotal: £' + $store.edit.invoiceItems.invoice?.subtotal"></p>
        <p x-text="'VAT: £' + $store.edit.invoiceItems.invoice?.vat"></p>

        <!-- Discount -->
        <template
          x-if="$store.edit.invoiceItems.invoice?.discount_type && $store.edit.invoiceItems.invoice?.discount_type !== 0">
          <template x-if="$store.edit.invoiceItems.invoice?.discount_type === 1">
            <p>
              Discount (Flat):
              <span x-text="'£' + $store.edit.invoiceItems.invoice?.discount_value"></span>
            </p>
          </template>
          <template x-if="$store.edit.invoiceItems.invoice?.discount_type === 2">
            <p>
              Discount (Percent):
              <span x-text="$store.edit.invoiceItems.invoice?.discVal_ifPercent + '%'"></span>
            </p>
          </template>
        </template>

        <!-- Deposit -->
        <template
          x-if="$store.edit.invoiceItems.invoice?.deposit_type && $store.edit.invoiceItems.invoice?.deposit_type !== 0">
          <template x-if="$store.edit.invoiceItems.invoice?.deposit_type === 1">
            <p>
              Deposit (Flat):
              <span x-text="'£' + $store.edit.invoiceItems.invoice?.deposit_value"></span>
            </p>
          </template>
          <template x-if="$store.edit.invoiceItems.invoice?.deposit_type === 2">
            <p>
              Deposit (Percent):
              <span x-text="$store.edit.invoiceItems.invoice?.depoVal_ifPercent + '%'"></span>
            </p>
          </template>
        </template>

        <p x-text="'Total: £' + $store.edit.invoiceItems.invoice?.total"></p>
      </div>
    </div>
  </template>

  <!-- “Choose Edit Type” Modal -->
  <div
    x-show="$store.edit.openEditModal"
    x-transition.opacity.duration.300
    class="fixed inset-0 z-20 bg-gray-800 bg-opacity-50">
    <div
      class="relative top-1/3 z-30 mx-auto w-1/4 rounded border border-vls/40 bg-vlp text-vls2 shadow-lg transition duration-300 dark:bg-zinc-900 dark:text-vds"
      @keydown.escape.window="$store.edit.openEditModal = false">
      <div class="p-6 text-center">
        <h2 class="text-xl font-medium mb-2 text-vls2 dark:text-vds">Choose Edit Type</h2>
        <p class="mb-4 text-sm font-normal text-vls2 dark:text-vds">How would you like to edit this invoice?</p>
        <!-- Overwrite -->
        <label class="modal-input-style mb-2 flex items-center justify-between p-2 font-medium">
          <div class="flex items-center">
            <input
              type="radio"
              value="editOverwrite"
              x-model="$store.edit.editMode"
              class="mr-4 ml-2 text-lg text-vlp dark:text-vds" />
            <span>Overwrite</span>
          </div>
        </label>
        <!-- Copy -->
        <label class="modal-input-style mb-4 flex items-center justify-between p-2 font-medium">
          <div class="flex items-center">
            <input
              type="radio"
              value="editCopy"
              x-model="$store.edit.editMode"
              class="mr-4 ml-2 text-lg text-vlp dark:text-vds" />
            <span>Copy Invoice</span>
          </div>
        </label>
        <div class="flex justify-between">
          <!-- Confirm/Close -->
          <button
            @click="$store.edit.editInvoice()"
            class="submit-button rounded bg-sky-700 p-1 text-sm text-slate-100 shadow-sm hover:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-sky-600">
            Edit
          </button>
          <button
            @click="$store.edit.openEditModal = false; $store.edit.editMode = ''"
            class="submit-button rounded bg-red-800 p-1 text-sm text-slate-100 shadow-sm hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-500">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- “Add Existing Item” Modal -->
  <div
    x-show="$store.edit.existingItems.showItemModal"
    x-transition.opacity.duration.300ms
    class="fixed inset-0 z-50 h-full w-full overflow-y-auto bg-gray-800 bg-opacity-50">
    <div
      class="relative top-1/4 mx-auto w-1/3 rounded border border-vls/40 bg-vlp text-vls2 shadow-lg dark:border-vls/40 dark:bg-zinc-900 dark:text-vds">
      <div
        class="p-6"
        @click.outside="$store.edit.existingItems.showItemModal = false; $store.edit.existingItems.openDropdown = false"
        @keydown.escape.window="$store.edit.existingItems.showItemModal = false; $store.edit.existingItems.openDropdown = false">
        <h3
          class="text-xl font-medium text-center mb-4"
          x-text="`${$store.clients.selectedClient?.name || ''}’s Items`"></h3>
        <p class="mb-2 text-center text-sm font-normal">Add from existing styles and samples</p>

        <!-- Dropdown of existing items -->
        <div class="relative mb-4">
          <button
            x-ref="existingItemsDropdown"
            @click="$store.edit.existingItems.openDropdown = !$store.edit.existingItems.openDropdown"
            class="w-full rounded border border-vls/40 hover:border-vls2 p-2 text-vls2/40 hover:text-vls2 transition focus:outline-none dark:border-vlp/40 dark:hover:border-vds dark:text-vlp/40 dark:hover:text-vds">
            Existing Items
          </button>
          <div
            x-show="$store.edit.existingItems.openDropdown"
            x-collapse.duration.500ms
            class="table-scrollbar absolute z-40 mt-2 max-h-80 w-full overflow-auto rounded border border-slate-300 bg-vlp shadow-lg dark:border-neutral-300 dark:bg-neutral-600">
            <table class="w-full text-vls2 dark:text-vds">
              <thead class="sticky top-0 bg-vlp dark:bg-zinc-900">
                <tr>
                  <th colspan="4" class="p-2">
                    <input
                      type="text"
                      placeholder="Search items..."
                      class="w-full bg-vlp p-1 text-center text-vla placeholder-vls transition duration-300 hover:placeholder-vla focus:outline-none dark:bg-zinc-900 dark:text-vred-300"
                      x-model="$store.edit.existingItems.searchQuery"
                      @input="$store.edit.searchItems()" />
                  </th>
                </tr>
                <tr>
                  <th class="p-1 text-left">Name</th>
                  <th class="p-1 text-right">Price</th>
                  <th class="p-1 text-right">Time</th>
                  <th class="p-1 text-center">Qty</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="item in $store.edit.existingItems.filteredItems" :key="item.frontEndId">
                  <tr class="cursor-pointer bg-vlp hover:bg-vlp2 dark:bg-vdp2 dark:hover:bg-vdp3">
                    <td class="p-1 text-left text-sm" x-text="item.name"></td>
                    <td class="p-1 text-right text-sm" x-text="item.price"></td>
                    <td class="p-1 text-right text-sm" x-text="item.type === 'sample' ? item.time : 'N/A'"></td>
                    <td class="p-1 text-sm">
                      <div class="flex items-center justify-center">
                        <input
                          type="number"
                          min="1"
                          x-model.number="item.quantity"
                          class="w-14 rounded border border-slate-300 bg-vlp p-1 text-vls2 focus:bg-vlp2 dark:border-neutral-400 dark:bg-vdp2 dark:text-vds" />
                        <button
                          @click="$store.edit.addNewItem(item)"
                          class="ml-2 text-vls2 transition hover:text-blue-400 dark:text-vds dark:hover:text-blue-400">
                          <svg class="size-4">
                            <use href="/icons/icons.svg#plus-circle" />
                          </svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Add a new item (Style or Sample) -->
        <p class="mb-2 text-center text-sm font-normal">Add a new style or sample</p>
        <div class="flex justify-between mb-4">
          <!-- Style -->
          <label class="modal-input-style mb-2 flex items-center justify-center p-4 cursor-pointer">
            <input type="radio" x-model="$store.edit.newItem.type" value="style" class="mr-2" />
            <span>Style</span>
          </label>
          <!-- Sample -->
          <label class="modal-input-style mb-2 flex items-center justify-center p-4 cursor-pointer">
            <input type="radio" x-model="$store.edit.newItem.type" value="sample" class="mr-2" />
            <span>Sample</span>
          </label>
        </div>

        <!-- If 'style' -->
        <div x-show="$store.edit.newItem.type === 'style'" x-collapse.duration.300ms class="mb-4">
          <input
            x-model="$store.edit.newItem.name"
            type="text"
            placeholder="Style Name"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <input
            x-model.number="$store.edit.newItem.price"
            type="number"
            placeholder="Price"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <input
            x-model.number="$store.edit.newItem.quantity"
            type="number"
            min="1"
            placeholder="Quantity"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <div class="flex justify-end">
            <button
              @click="$store.edit.addNewItem($store.edit.newItem)"
              class="rounded bg-sky-700 mr-4 p-1 text-sm text-vlp transition hover:bg-sky-800">
              Add
            </button>
            <!-- Close the modal -->
            <button
              @click="$store.edit.existingItems.showItemModal = false; $store.edit.existingItems.openDropdown = false"
              class="rounded bg-red-700 p-1 text-sm text-vlp transition hover:bg-red-800">
              Close
            </button>
          </div>
        </div>

        <!-- If 'sample' -->
        <div x-show="$store.edit.newItem.type === 'sample'" x-collapse.duration.300ms class="mb-4">
          <input
            x-model="$store.edit.newItem.name"
            type="text"
            placeholder="Sample Name"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <input
            x-model.number="$store.edit.newItem.price"
            type="number"
            placeholder="Price"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <input
            x-model.number="$store.edit.newItem.time"
            type="number"
            placeholder="Time (minutes)"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <input
            x-model.number="$store.edit.newItem.quantity"
            type="number"
            min="1"
            placeholder="Quantity"
            class="modal-input-style mb-2 w-full p-2 text-sm" />
          <div class="flex justify-end">
            <button
              @click="$store.edit.addNewItem($store.edit.newItem)"
              class="rounded bg-sky-700 mr-4 p-1 text-sm text-vlp transition hover:bg-sky-800">
              Add
            </button>
            <!-- Close the modal -->
            <button
              @click="$store.edit.existingItems.showItemModal = false; $store.edit.existingItems.openDropdown = false"
              class="rounded bg-red-700 p-1 text-sm text-vlp transition hover:bg-red-800">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
